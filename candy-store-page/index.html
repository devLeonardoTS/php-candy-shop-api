<!DOCTYPE html>
<html lang="pt-BR">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Loja de Doces - Krazy Kandy</title>
  </head>
  <body>
    <h1>Candy Store</h1>

    <h2>Store Stats</h2>
    <p>Total Candies Sold: <span id="totalCandiesSold">0</span></p>
    <p>Total Revenue: $<span id="totalRevenue">0.00</span></p>

    <form id="candyForm">
      <input type="text" id="name" placeholder="Candy Name" required />
      <input
        type="number"
        id="price"
        step="0.01"
        placeholder="Price"
        required
      />
      <input type="number" id="stock" placeholder="Stock" required />
      <input type="file" id="image" />
      <button type="submit">Add Candy</button>
    </form>

    <h2>Available Candies</h2>
    <div id="candies"></div>

    <script>
      const baseUrl = "http://localhost:8000";
      const statsUrl = "http://localhost:8000/api/stats";
      const candiesUrl = "http://localhost:8000/api/candies";

      // Fetch and display store stats
      async function fetchStats() {
        const response = await fetch(statsUrl);
        const stats = await response.json();
        document.getElementById("totalCandiesSold").innerText =
          stats.total_candies_sold;
        document.getElementById("totalRevenue").innerText =
          stats.total_revenue.toFixed(2);
      }

      async function fetchCandies() {
        const response = await fetch(candiesUrl);
        const candies = await response.json();
        const candyDiv = document.getElementById("candies");
        candyDiv.innerHTML = candies
          .map(
            (candy) => `
                <div>
                    <h3>${candy.name} - $${candy.price}</h3>
                    <p>Stock: ${candy.stock}</p>
                    <img src="${baseUrl}/storage/${candy.image}" alt="${candy.name}" width="100" />
                    <button onclick="sellCandy(${candy.id})">Sell</button>
                    <button onclick="deleteCandy(${candy.id})">Delete</button>
                </div>
            `
          )
          .join("");
        fetchStats(); // Update stats when candies are fetched
      }

      async function sellCandy(id) {
        const response = await fetch(`${candiesUrl}/${id}/sell`, {
          method: "POST",
        });
        if (response.ok) {
          fetchCandies(); // Refresh candies and stats
        } else {
          const error = await response.json();
          alert(error.message);
        }
      }

      async function deleteCandy(id) {
        await fetch(`${candiesUrl}/${id}`, { method: "DELETE" });
        fetchCandies();
      }

      document
        .getElementById("candyForm")
        .addEventListener("submit", async (e) => {
          e.preventDefault();
          const formData = new FormData();
          formData.append("name", document.getElementById("name").value);
          formData.append("price", document.getElementById("price").value);
          formData.append("stock", document.getElementById("stock").value);
          const image = document.getElementById("image").files[0];
          if (image) formData.append("image", image);

          await fetch(candiesUrl, { method: "POST", body: formData });
          fetchCandies();
        });

      fetchCandies();
    </script>
  </body>
</html>
